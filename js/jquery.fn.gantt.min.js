/*jshint shadow:true*//*globals jQuery, alert*/(function($){"use strict";$.fn.gantt=function(options){var cookieKey="jquery.fn.gantt",scales=["hours","days","weeks","months"],settings={source:null,itemsPerPage:7,months:["January","February","March","April","May","June","July","August","September","October","November","December"],dow:["S","M","T","W","T","F","S"],startPos:new Date,navigate:"buttons",scale:"days",useCookie:!1,maxScale:"months",minScale:"hours",waitText:"Please wait...",onItemClick:function(e){return},onAddClick:function(e){return},scrollToToday:!0};$.extend($.expr[":"],{findday:function(e,t,n){var r=new Date(parseInt(n[3],10)),i=$(e).attr("id");i=i?i:"";var s=i.indexOf("-")+1,o=new Date(parseInt(i.substring(s,i.length),10));r=new Date(r.getFullYear(),r.getMonth(),r.getDate());o=new Date(o.getFullYear(),o.getMonth(),o.getDate());return r.getTime()===o.getTime()}});$.extend($.expr[":"],{findweek:function(e,t,n){var r=new Date(parseInt(n[3],10)),i=$(e).attr("id");i=i?i:"";var s=i.indexOf("-")+1;r=r.getFullYear()+"-"+r.getDayForWeek().getWeekOfYear();var o=i.substring(s,i.length);return r===o}});$.extend($.expr[":"],{findmonth:function(e,t,n){var r=new Date(parseInt(n[3],10));r=r.getFullYear()+"-"+r.getMonth();var i=$(e).attr("id");i=i?i:"";var s=i.indexOf("-")+1,o=i.substring(s,i.length);return r===o}});Date.prototype.getWeekId=function(){var e=this.getFullYear(),t=this.getDayForWeek().getWeekOfYear(),n=this.getMonth();n===11&&t===1&&e++;return"dh-"+e+"-"+t};Date.prototype.genRepDate=function(){switch(settings.scale){case"hours":return this.getTime();case"weeks":return this.getDayForWeek().getTime();case"months":return(new Date(this.getFullYear(),this.getMonth(),1)).getTime();default:return this.getTime()}};Date.prototype.getDayOfYear=function(){var e=new Date(this.getFullYear(),0,0),t=new Date(this.getFullYear(),this.getMonth(),this.getDate());return Math.ceil((t-e)/864e5)};Date.prototype.getWeekOfYear=function(){var e=new Date(this.getFullYear(),0,1),t=new Date(this.getFullYear(),this.getMonth(),this.getDate());e.getDay()>3&&(e=new Date(t.getFullYear(),0,7-e.getDay()));var n=t.getDayOfYear()-e.getDayOfYear();return Math.ceil(n/7)};Date.prototype.getDaysInMonth=function(){return 32-(new Date(this.getFullYear(),this.getMonth(),32)).getDate()};Date.prototype.hasWeek=function(){var e=new Date(this.valueOf());e.setDate(e.getDate()-e.getDay());var t=new Date(this.valueOf());t.setDate(t.getDate()+(6-t.getDay()));return e.getMonth()===t.getMonth()?!0:e.getMonth()===this.getMonth()&&t.getDate()<4||e.getMonth()!==this.getMonth()&&t.getDate()>=4};Date.prototype.getDayForWeek=function(){var e=new Date(this.valueOf());e.setDate(e.getDate()-e.getDay());var t=new Date(this.valueOf());t.setDate(t.getDate()+(6-t.getDay()));return e.getMonth()===t.getMonth()||e.getMonth()!==t.getMonth()&&t.getDate()>=4?new Date(t.setDate(t.getDate()-3)):new Date(e.setDate(e.getDate()+3))};var core={elementFromPoint:function(e,t){if($.browser.msie){e-=$(document).scrollLeft();t-=$(document).scrollTop()}else{e-=window.pageXOffset;t-=window.pageYOffset}return document.elementFromPoint(e,t)},create:function(e){if(typeof settings.source!="string"){e.data=settings.source;core.init(e)}else $.getJSON(settings.source,function(t){e.data=t;core.init(e)})},init:function(e){e.rowsNum=e.data.length;e.pageCount=Math.ceil(e.rowsNum/settings.itemsPerPage);e.rowsOnLastPage=e.rowsNum-Math.floor(e.rowsNum/settings.itemsPerPage)*settings.itemsPerPage;e.dateStart=tools.getMinDate(e);e.dateEnd=tools.getMaxDate(e);core.waitToggle(e,!0,function(){core.render(e)})},render:function(e){var t=$('<div class="fn-content"/>'),n=core.leftPanel(e);t.append(n);var r=core.rightPanel(e,n),i,s;t.append(r);t.append(core.navigation(e));var o=r.find(".dataPanel");e.gantt=$('<div class="fn-gantt" />').append(t);$(e).html(e.gantt);e.scrollNavigation.panelMargin=parseInt(o.css("margin-left").replace("px",""),10);e.scrollNavigation.panelMaxPos=o.width()-r.width();e.scrollNavigation.canScroll=o.width()>r.width();core.markNow(e);core.fillData(e,o,n);if(settings.useCookie){var u=$.cookie(this.cookieKey+"ScrollPos");u&&(e.hPosition=u)}if(settings.scrollToToday){var a=Math.round((settings.startPos/1e3-e.dateStart/1e3)/86400)-2;if(a>0&&e.hPosition!==0){if(e.scaleOldWidth){i=o.width()-r.width();s=i*e.hPosition/e.scaleOldWidth;s=s>0?0:s;o.css({"margin-left":s+"px"});e.scrollNavigation.panelMargin=s;e.hPosition=s;e.scaleOldWidth=null}else{o.css({"margin-left":e.hPosition+"px"});e.scrollNavigation.panelMargin=e.hPosition}core.repositionLabel(e)}else core.repositionLabel(e)}else if(e.hPosition!==0){if(e.scaleOldWidth){i=o.width()-r.width();s=i*e.hPosition/e.scaleOldWidth;s=s>0?0:s;o.css({"margin-left":s+"px"});e.scrollNavigation.panelMargin=s;e.hPosition=s;e.scaleOldWidth=null}else{o.css({"margin-left":e.hPosition+"px"});e.scrollNavigation.panelMargin=e.hPosition}core.repositionLabel(e)}else core.repositionLabel(e);o.css({height:n.height()});core.waitToggle(e,!1)},leftPanel:function(e){var t=$('<div class="leftPanel"/>').append($('<div class="row spacer"/>').css("height",tools.getCellSize()*e.headerRows+"px").css("width","100%")),n=[];$.each(e.data,function(t,r){if(t>=e.pageNum*settings.itemsPerPage&&t<e.pageNum*settings.itemsPerPage+settings.itemsPerPage){n.push('<div class="row name row'+t+(r.desc?"":" fn-wide")+'" id="rowheader'+t+'" offset="'+t*tools.getCellSize()+'">');n.push('<span class="fn-label'+(r.cssClass?" "+r.cssClass:"")+'">'+r.name+"</span>");n.push("</div>");if(r.desc){n.push('<div class="row desc row'+t+' " id="RowdId_'+t+'" data-id="'+r.id+'">');n.push('<span class="fn-label'+(r.cssClass?" "+r.cssClass:"")+'">'+r.desc+"</span>");n.push("</div>")}}});t.append(n.join(""));return t},dataPanel:function(e,t){var n=$('<div class="dataPanel" style="width: '+t+'px;"/>'),r=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";document.attachEvent?e.attachEvent("on"+r,function(t){core.wheelScroll(e,t)}):document.addEventListener&&e.addEventListener(r,function(t){core.wheelScroll(e,t)},!1);n.click(function(t){t.stopPropagation();var n,r,i=$(e).find(".fn-gantt .leftPanel"),s=$(e).find(".fn-gantt .dataPanel");switch(settings.scale){case"weeks":r=tools.getCellSize()*2;break;case"months":r=tools.getCellSize();break;case"hours":case"days":r=tools.getCellSize()*3;break;default:r=tools.getCellSize()*2}var o=core.elementFromPoint(t.pageX,s.offset().top+r);o.className==="fn-label"?o=$(o.parentNode):o=$(o);var u=o.attr("repdate"),a=core.elementFromPoint(i.offset().left+i.width()-10,t.pageY);a.className.indexOf("fn-label")===0?a=$(a.parentNode):a=$(a);var f=a.data().id;settings.onAddClick(u,f)});return n},rightPanel:function(e,t){var n=null,r=[" sn"," wd"," wd"," wd"," wd"," wd"," sa"],i=[" sn","","","","",""," sa"],s=['<div class="row"/>'],o=0,u=['<div class="row"/>'],a=0,f=[],l=0,c=[],h=[],p=new Date;p=new Date(p.getFullYear(),p.getMonth(),p.getDate());var d=settings.holidays?settings.holidays.join():"";switch(settings.scale){case"hours":n=tools.parseTimeRange(e.dateStart,e.dateEnd,e.scaleStep);var v=n[0].getFullYear(),m=n[0].getMonth(),g=n[0];for(var y=0;y<n.length;y++){var b=n[y],w=b.getFullYear();if(w!==v){s.push('<div class="row header year" style="width: '+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");v=w;o=0}o++;var E=b.getMonth();if(E!==m){u.push('<div class="row header month" style="width: '+tools.getCellSize()*a+'px"><div class="fn-label">'+settings.months[m]+"</div></div>");m=E;a=0}a++;var S=b.getDay(),x=g.getDay(),T=r[S],N=g.getTime();d.indexOf((new Date(b.getFullYear(),b.getMonth(),b.getDate())).getTime())>-1&&(T="holiday");if(S!==x){var C=p-g===0?" today":d.indexOf(N)>-1?"holiday":r[x];f.push('<div class="row day '+C+'" '+' style="width: '+tools.getCellSize()*l+'px;"> '+' <div class="fn-label">'+g.getDate()+"</div></div>");c.push('<div class="row day '+C+'" '+' style="width: '+tools.getCellSize()*l+'px;"> '+' <div class="fn-label">'+settings.dow[x]+"</div></div>");g=b;l=0}l++;h.push('<div class="row day '+T+'" id="dh-'+b.getTime()+'"  offset="'+y*tools.getCellSize()+'"  repdate="'+b.genRepDate()+'"> '+b.getHours()+"</div>")}s.push('<div class="row header year" style="width: '+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");u.push('<div class="row header month" style="width: '+tools.getCellSize()*a+'px"><div class="fn-label">'+settings.months[m]+"</div></div>");var T=r[g.getDay()];d.indexOf((new Date(g.getFullYear(),g.getMonth(),g.getDate())).getTime())>-1&&(T="holiday");f.push('<div class="row day '+T+'" '+' style="width: '+tools.getCellSize()*l+'px;"> '+' <div class="fn-label">'+g.getDate()+"</div></div>");c.push('<div class="row day '+T+'" '+' style="width: '+tools.getCellSize()*l+'px;"> '+' <div class="fn-label">'+settings.dow[g.getDay()]+"</div></div>");var k=core.dataPanel(e,n.length*tools.getCellSize());k.append(s.join(""));k.append(u.join(""));k.append($('<div class="row"/>').html(f.join("")));k.append($('<div class="row"/>').html(c.join("")));k.append($('<div class="row"/>').html(h.join("")));break;case"weeks":n=tools.parseWeeksRange(e.dateStart,e.dateEnd);s=['<div class="row"/>'];u=['<div class="row"/>'];var v=n[0].getFullYear(),m=n[0].getMonth(),g=n[0];for(var y=0;y<n.length;y++){var b=n[y];if(b.getFullYear()!==v){s.push('<div class="row header year" style="width: '+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");v=b.getFullYear();o=0}o++;if(b.getMonth()!==m){u.push('<div class="row header month" style="width:'+tools.getCellSize()*a+'px;"><div class="fn-label">'+settings.months[m]+"</div></div>");m=b.getMonth();a=0}a++;f.push('<div class="row day wd"  id="'+b.getWeekId()+'" offset="'+y*tools.getCellSize()+'" repdate="'+b.genRepDate()+'"> '+' <div class="fn-label">'+b.getWeekOfYear()+"</div></div>")}s.push('<div class="row header year" style="width: '+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");u.push('<div class="row header month" style="width: '+tools.getCellSize()*a+'px"><div class="fn-label">'+settings.months[m]+"</div></div>");var k=core.dataPanel(e,n.length*tools.getCellSize());k.append(s.join("")+u.join("")+f.join("")+c.join(""));break;case"months":n=tools.parseMonthsRange(e.dateStart,e.dateEnd);var v=n[0].getFullYear(),m=n[0].getMonth(),g=n[0];for(var y=0;y<n.length;y++){var b=n[y];if(b.getFullYear()!==v){s.push('<div class="row header year" style="width: '+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");v=b.getFullYear();o=0}o++;u.push('<div class="row day wd" id="dh-'+tools.genId(b.getTime())+'" offset="'+y*tools.getCellSize()+'" repdate="'+b.genRepDate()+'">'+(1+b.getMonth())+"</div>")}s.push('<div class="row header year" style="width: '+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");u.push('<div class="row header month" style="width: '+tools.getCellSize()*a+'px">"<div class="fn-label">'+settings.months[m]+"</div></div>");var k=core.dataPanel(e,n.length*tools.getCellSize());k.append(s.join(""));k.append(u.join(""));k.append($('<div class="row"/>').html(f.join("")));k.append($('<div class="row"/>').html(c.join("")));break;default:n=tools.parseDateRange(e.dateStart,e.dateEnd);var v=n[0].getFullYear(),m=n[0].getMonth(),g=n[0];for(var y=0;y<n.length;y++){var b=n[y];if(b.getFullYear()!==v){s.push('<div class="row header year" style="width:'+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");v=b.getFullYear();o=0}o++;if(b.getMonth()!==m){u.push('<div class="row header month" style="width:'+tools.getCellSize()*a+'px;"><div class="fn-label">'+settings.months[m]+"</div></div>");m=b.getMonth();a=0}a++;var x=b.getDay(),T=r[x];d.indexOf((new Date(b.getFullYear(),b.getMonth(),b.getDate())).getTime())>-1&&(T="holiday");f.push('<div class="row day '+T+'" '+' id="dh-'+tools.genId(b.getTime())+'" offset="'+y*tools.getCellSize()+'" repdate="'+b.genRepDate()+"> "+' <div class="fn-label">'+b.getDate()+"</div></div>");c.push('<div class="row day '+T+'" '+' id="dw-'+tools.genId(b.getTime())+'"  repdate="'+b.genRepDate()+'"> '+' <div class="fn-label">'+settings.dow[x]+"</div></div>")}s.push('<div class="row header year" style="width: '+tools.getCellSize()*o+'px;"><div class="fn-label">'+v+"</div></div>");u.push('<div class="row header month" style="width: '+tools.getCellSize()*a+'px"><div class="fn-label">'+settings.months[m]+"</div></div>");var k=core.dataPanel(e,n.length*tools.getCellSize());k.append(s.join(""));k.append(u.join(""));k.append($('<div class="row"/>').html(f.join("")));k.append($('<div class="row"/>').html(c.join("")))}return $('<div class="rightPanel"></div>').append(k)},navigation:function(e){var t=null;if(settings.navigate==="scroll"){t=$('<div class="navigate" />').append($('<div class="nav-slider" />').append($('<div class="nav-slider-left" />').append($('<span role="button" class="nav-link nav-page-back"/>').html("&lt;").click(function(){core.navigatePage(e,-1)})).append($('<div class="page-number"/>').append($("<span/>").html(e.pageNum+1+" of "+e.pageCount))).append($('<span role="button" class="nav-link nav-page-next"/>').html("&gt;").click(function(){core.navigatePage(e,1)})).append($('<span role="button" class="nav-link nav-now"/>').html("&#9679;").click(function(){core.navigateTo(e,"now")})).append($('<span role="button" class="nav-link nav-prev-week"/>').html("&lt;&lt;").click(function(){settings.scale==="hours"?core.navigateTo(e,tools.getCellSize()*8):settings.scale==="days"?core.navigateTo(e,tools.getCellSize()*30):settings.scale==="weeks"?core.navigateTo(e,tools.getCellSize()*12):settings.scale==="months"&&core.navigateTo(e,tools.getCellSize()*6)})).append($('<span role="button" class="nav-link nav-prev-day"/>').html("&lt;").click(function(){settings.scale==="hours"?core.navigateTo(e,tools.getCellSize()*4):settings.scale==="days"?core.navigateTo(e,tools.getCellSize()*7):settings.scale==="weeks"?core.navigateTo(e,tools.getCellSize()*4):settings.scale==="months"&&core.navigateTo(e,tools.getCellSize()*3)}))).append($('<div class="nav-slider-content" />').append($('<div class="nav-slider-bar" />').append($('<a class="nav-slider-button" />')).mousedown(function(t){t.preventDefault&&t.preventDefault();e.scrollNavigation.scrollerMouseDown=!0;core.sliderScroll(e,t)}).mousemove(function(t){e.scrollNavigation.scrollerMouseDown&&core.sliderScroll(e,t)}))).append($('<div class="nav-slider-right" />').append($('<span role="button" class="nav-link nav-next-day"/>').html("&gt;").click(function(){settings.scale==="hours"?core.navigateTo(e,tools.getCellSize()*-4):settings.scale==="days"?core.navigateTo(e,tools.getCellSize()*-7):settings.scale==="weeks"?core.navigateTo(e,tools.getCellSize()*-4):settings.scale==="months"&&core.navigateTo(e,tools.getCellSize()*-3)})).append($('<span role="button" class="nav-link nav-next-week"/>').html("&gt;&gt;").click(function(){settings.scale==="hours"?core.navigateTo(e,tools.getCellSize()*-8):settings.scale==="days"?core.navigateTo(e,tools.getCellSize()*-30):settings.scale==="weeks"?core.navigateTo(e,tools.getCellSize()*-12):settings.scale==="months"&&core.navigateTo(e,tools.getCellSize()*-6)})).append($('<span role="button" class="nav-link nav-zoomIn"/>').html("&#43;").click(function(){core.zoomInOut(e,-1)})).append($('<span role="button" class="nav-link nav-zoomOut"/>').html("&#45;").click(function(){core.zoomInOut(e,1)}))));$(document).mouseup(function(){e.scrollNavigation.scrollerMouseDown=!1})}else t=$('<div class="navigate" />').append($('<span role="button" class="nav-link nav-page-back"/>').html("&lt;").click(function(){core.navigatePage(e,-1)})).append($('<div class="page-number"/>').append($("<span/>").html(e.pageNum+1+" of "+e.pageCount))).append($('<span role="button" class="nav-link nav-page-next"/>').html("&gt;").click(function(){core.navigatePage(e,1)})).append($('<span role="button" class="nav-link nav-begin"/>').html("&#124;&lt;").click(function(){core.navigateTo(e,"begin")})).append($('<span role="button" class="nav-link nav-prev-week"/>').html("&lt;&lt;").click(function(){core.navigateTo(e,tools.getCellSize()*7)})).append($('<span role="button" class="nav-link nav-prev-day"/>').html("&lt;").click(function(){core.navigateTo(e,tools.getCellSize())})).append($('<span role="button" class="nav-link nav-now"/>').html("&#9679;").click(function(){core.navigateTo(e,"now")})).append($('<span role="button" class="nav-link nav-next-day"/>').html("&gt;").click(function(){core.navigateTo(e,tools.getCellSize()*-1)})).append($('<span role="button" class="nav-link nav-next-week"/>').html("&gt;&gt;").click(function(){core.navigateTo(e,tools.getCellSize()*-7)})).append($('<span role="button" class="nav-link nav-end"/>').html("&gt;&#124;").click(function(){core.navigateTo(e,"end")})).append($('<span role="button" class="nav-link nav-zoomIn"/>').html("&#43;").click(function(){core.zoomInOut(e,-1)})).append($('<span role="button" class="nav-link nav-zoomOut"/>').html("&#45;").click(function(){core.zoomInOut(e,1)}));return $('<div class="bottom"/>').append(t)},createProgressBar:function(e,t,n,r,i){var s=tools.getCellSize(),o=tools.getProgressBarMargin()||0,u=$('<div class="bar"><div class="fn-label">'+r+"</div></div>").addClass(t).css({width:s*e-o+5}).data("dataObj",i);n&&u.mouseover(function(e){var t=$('<div class="fn-gantt-hint" />').html(n);$("body").append(t);t.css("left",e.pageX);t.css("top",e.pageY);t.show()}).mouseout(function(){$(".fn-gantt-hint").remove()}).mousemove(function(e){$(".fn-gantt-hint").css("left",e.pageX);$(".fn-gantt-hint").css("top",e.pageY+15)});u.click(function(e){e.stopPropagation();settings.onItemClick($(this).data("dataObj"))});return u},markNow:function(e){switch(settings.scale){case"weeks":var t=Date.parse(new Date);t=Math.floor(t/364e5)*364e5;$(e).find(':findweek("'+t+'")').removeClass("wd").addClass("today");break;case"months":$(e).find(':findmonth("'+(new Date).getTime()+'")').removeClass("wd").addClass("today");break;default:var t=Date.parse(new Date);t=Math.floor(t/364e5)*364e5;$(e).find(':findday("'+t+'")').removeClass("wd").addClass("today")}},fillData:function(e,t,n){var r=function(e){try{e=e.replace("rgb(","").replace(")","");var t=e.split(","),n=parseInt(t[0],10),r=parseInt(t[1],10),i=parseInt(t[2],10),s=Math.round((255-(.299*n+.587*r+.114*i))*.9,1);return"rgb("+s+", "+s+", "+s+")"}catch(o){return""}};$.each(e.data,function(n,i){n>=e.pageNum*settings.itemsPerPage&&n<e.pageNum*settings.itemsPerPage+settings.itemsPerPage&&$.each(i.values,function(i,s){var o=null;switch(settings.scale){case"hours":var u=tools.genId(tools.dateDeserialize(s.from).getTime(),e.scaleStep),a=$(e).find("#dh-"+u),f=tools.genId(tools.dateDeserialize(s.to).getTime(),e.scaleStep),l=$(e).find("#dh-"+f),c=a.attr("offset"),h=l.attr("offset"),p=Math.floor((h-c)/tools.getCellSize())+1;o=core.createProgressBar(p,s.customClass?s.customClass:"",s.desc?s.desc:"",s.label?s.label:"",s.dataObj?s.dataObj:null);var d=$(e).find("#rowheader"+n),v=tools.getCellSize()*3+2+parseInt(d.attr("offset"),10);o.css({"margin-top":v,"margin-left":Math.floor(c)});t.append(o);break;case"weeks":var m=tools.dateDeserialize(s.from),g=tools.dateDeserialize(s.to);m.getDate()<=3&&m.getMonth()===0&&m.setDate(m.getDate()+4);m.getDate()<=3&&m.getMonth()===0&&m.setDate(m.getDate()+4);g.getDate()<=3&&g.getMonth()===0&&g.setDate(g.getDate()+4);var a=$(e).find("#"+m.getWeekId()),c=a.attr("offset"),l=$(e).find("#"+g.getWeekId()),h=l.attr("offset"),p=Math.round((h-c)/tools.getCellSize())+1;o=core.createProgressBar(p,s.customClass?s.customClass:"",s.desc?s.desc:"",s.label?s.label:"",s.dataObj?s.dataObj:null);var d=$(e).find("#rowheader"+n),v=tools.getCellSize()*3+2+parseInt(d.attr("offset"),10);o.css({"margin-top":v,"margin-left":Math.floor(c)});t.append(o);break;case"months":var m=tools.dateDeserialize(s.from),g=tools.dateDeserialize(s.to);m.getDate()<=3&&m.getMonth()===0&&m.setDate(m.getDate()+4);m.getDate()<=3&&m.getMonth()===0&&m.setDate(m.getDate()+4);g.getDate()<=3&&g.getMonth()===0&&g.setDate(g.getDate()+4);var a=$(e).find("#dh-"+tools.genId(m.getTime())),c=a.attr("offset"),l=$(e).find("#dh-"+tools.genId(g.getTime())),h=l.attr("offset"),p=Math.round((h-c)/tools.getCellSize())+1;o=core.createProgressBar(p,s.customClass?s.customClass:"",s.desc?s.desc:"",s.label?s.label:"",s.dataObj?s.dataObj:null);var d=$(e).find("#rowheader"+n),v=tools.getCellSize()*2+2+parseInt(d.attr("offset"),10);o.css({"margin-top":v,"margin-left":Math.floor(c)});t.append(o);break;default:var u=tools.genId(tools.dateDeserialize(s.from).getTime()),f=tools.genId(tools.dateDeserialize(s.to).getTime()),a=$(e).find("#dh-"+u),c=a.attr("offset"),p=Math.floor((f/1e3-u/1e3)/86400)+1;o=core.createProgressBar(p,s.customClass?s.customClass:"",s.desc?s.desc:"",s.label?s.label:"",s.dataObj?s.dataObj:null);var d=$(e).find("#rowheader"+n),v=tools.getCellSize()*4+2+parseInt(d.attr("offset"),10);o.css({"margin-top":v,"margin-left":Math.floor(c)});t.append(o)}var y=o.find(".fn-label");if(y&&o.length){var b=r(o[0].style.backgroundColor);y.css("color",b)}else y&&y.css("color","")})})},navigateTo:function(e,t){var n=$(e).find(".fn-gantt .rightPanel"),r=n.find(".dataPanel");r.click=function(){alert(arguments.join(""))};var i=n.width(),s=r.width();switch(t){case"begin":r.animate({"margin-left":"0px"},"fast",function(){core.repositionLabel(e)});e.scrollNavigation.panelMargin=0;break;case"end":var o=s-i;e.scrollNavigation.panelMargin=o*-1;r.animate({"margin-left":"-"+o+"px"},"fast",function(){core.repositionLabel(e)});break;case"now":if(!e.scrollNavigation.canScroll)return!1;var u=(s-i)*-1,a=r.css("margin-left").replace("px",""),t=r.find(".today").offset().left-r.offset().left;t*=-1;t>0?t=0:t<u&&(t=u);r.animate({"margin-left":t+"px"},"fast",core.repositionLabel(e));e.scrollNavigation.panelMargin=t;break;default:var u=(s-i)*-1,a=r.css("margin-left").replace("px",""),t=parseInt(a,10)+t;t<=0&&t>=u&&r.animate({"margin-left":t+"px"},"fast",core.repositionLabel(e));e.scrollNavigation.panelMargin=t}},navigatePage:function(e,t){e.pageNum+t>=0&&e.pageNum+t<Math.ceil(e.rowsNum/settings.itemsPerPage)&&core.waitToggle(e,!0,function(){e.pageNum+=t;e.hPosition=$(".fn-gantt .dataPanel").css("margin-left").replace("px","");e.scaleOldWidth=!1;core.init(e)})},zoomInOut:function(e,t){core.waitToggle(e,!0,function(){var n=t<0,r=e.scaleStep+t*3;r=r<=1?1:r===4?3:r;var i=settings.scale,s=e.headerRows;if(settings.scale==="hours"&&r>=13){i="days";s=4;r=13}else if(settings.scale==="days"&&n){i="hours";s=5;r=12}else if(settings.scale==="days"&&!n){i="weeks";s=3;r=13}else if(settings.scale==="weeks"&&!n){i="months";s=2;r=14}else if(settings.scale==="weeks"&&n){i="days";s=4;r=13}else if(settings.scale==="months"&&n){i="weeks";s=3;r=13}if(n&&$.inArray(i,scales)<$.inArray(settings.minScale,scales)||!n&&$.inArray(i,scales)>$.inArray(settings.maxScale,scales)){core.init(e);return}e.scaleStep=r;settings.scale=i;e.headerRows=s;var o=$(e).find(".fn-gantt .rightPanel"),u=o.find(".dataPanel");e.hPosition=u.css("margin-left").replace("px","");e.scaleOldWidth=u.width()-o.width();if(settings.useCookie){$.cookie(this.cookieKey+"CurrentScale",settings.scale);$.cookie(this.cookieKey+"ScrollPos",null)}core.init(e)})},mouseScroll:function(e,t){var n=$(e).find(".fn-gantt .dataPanel");n.css("cursor","move");var r=n.offset(),i=e.scrollNavigation.mouseX===null?t.pageX:e.scrollNavigation.mouseX,s=t.pageX-i;e.scrollNavigation.mouseX=t.pageX;core.scrollPanel(e,s);clearTimeout(e.scrollNavigation.repositionDelay);e.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,50,e)},wheelScroll:function(e,t){var n=t.detail?t.detail*-50:t.wheelDelta/120*50;core.scrollPanel(e,n);clearTimeout(e.scrollNavigation.repositionDelay);e.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,50,e);if(!t.preventDefault)return!1;t.preventDefault()},sliderScroll:function(e,t){var n=$(e).find(".nav-slider-bar"),r=n.find(".nav-slider-button"),i=$(e).find(".fn-gantt .rightPanel"),s=i.find(".dataPanel"),o=n.offset(),u=n.width(),a=r.width(),f,l;if(t.pageX>=o.left&&t.pageX<=o.left+u){f=t.pageX-o.left;f-=a/2;r.css("left",f);l=s.width()-i.width();var c=f*l/u*-1;if(c>=0){s.css("margin-left","0px");e.scrollNavigation.panelMargin=0}else if(f>=u-a*1){s.css("margin-left",l*-1+"px");e.scrollNavigation.panelMargin=l*-1}else{s.css("margin-left",c+"px");e.scrollNavigation.panelMargin=c}clearTimeout(e.scrollNavigation.repositionDelay);e.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,5,e)}},scrollPanel:function(e,t){if(!e.scrollNavigation.canScroll)return!1;var n=parseInt(e.scrollNavigation.panelMargin,10)+t;if(n>0){e.scrollNavigation.panelMargin=0;$(e).find(".fn-gantt .dataPanel").css("margin-left",e.scrollNavigation.panelMargin+"px")}else if(n<e.scrollNavigation.panelMaxPos*-1){e.scrollNavigation.panelMargin=e.scrollNavigation.panelMaxPos*-1;$(e).find(".fn-gantt .dataPanel").css("margin-left",e.scrollNavigation.panelMargin+"px")}else{e.scrollNavigation.panelMargin=n;$(e).find(".fn-gantt .dataPanel").css("margin-left",e.scrollNavigation.panelMargin+"px")}core.synchronizeScroller(e)},synchronizeScroller:function(e){if(settings.navigate==="scroll"){var t=$(e).find(".fn-gantt .rightPanel"),n=t.find(".dataPanel"),r=$(e).find(".nav-slider-bar"),i=r.find(".nav-slider-button"),s=r.width(),o=i.width(),u=n.width()-t.width(),a=0;n.css("margin-left")&&(a=n.css("margin-left").replace("px",""));var f=a*s/u-i.width()*.25;f=f>0?0:f*-1>=s-o*.75?(s-o*1.25)*-1:f;i.css("left",f*-1)}},repositionLabel:function(e){setTimeout(function(){var t;if(!e)t=$(".fn-gantt .rightPanel .dataPanel");else{var n=$(e).find(".fn-gantt .rightPanel");t=n.find(".dataPanel")}settings.useCookie&&$.cookie(this.cookieKey+"ScrollPos",t.css("margin-left").replace("px",""))},500)},waitToggle:function(e,t,n){if(t){var r=$(e).offset(),i=$(e).outerWidth(),s=$(e).outerHeight();e.loader||(e.loader=$('<div class="fn-gantt-loader" style="position: absolute; top: '+r.top+"px; left: "+r.left+"px; width: "+i+"px; height: "+s+'px;">'+'<div class="fn-gantt-loader-spinner"><span>'+settings.waitText+"</span></div></div>"));$("body").append(e.loader);setTimeout(n,100)}else{e.loader&&e.loader.remove();e.loader=null}}},tools={getMaxDate:function(e){var t=null;$.each(e.data,function(e,n){$.each(n.values,function(e,n){t=t<tools.dateDeserialize(n.to)?tools.dateDeserialize(n.to):t})});switch(settings.scale){case"hours":t.setHours(Math.ceil(t.getHours()/e.scaleStep)*e.scaleStep);t.setHours(t.getHours()+e.scaleStep*3);break;case"weeks":var n=new Date(t.getTime()),n=new Date(n.setDate(n.getDate()+21)),r=Math.floor(n.getDate()/7)*7;t=new Date(n.getFullYear(),n.getMonth(),r===0?4:r-3);break;case"months":var n=new Date(t.getFullYear(),t.getMonth(),1);n.setMonth(n.getMonth()+2);t=new Date(n.getFullYear(),n.getMonth(),1);break;default:t.setHours(0);t.setDate(t.getDate()+3)}return t},getMinDate:function(e){var t=null;$.each(e.data,function(e,n){$.each(n.values,function(e,n){t=t>tools.dateDeserialize(n.from)||t===null?tools.dateDeserialize(n.from):t})});switch(settings.scale){case"hours":t.setHours(Math.floor(t.getHours()/e.scaleStep)*e.scaleStep);t.setHours(t.getHours()-e.scaleStep*3);break;case"weeks":var n=new Date(t.getTime()),n=new Date(n.setDate(n.getDate()-21)),r=Math.floor(n.getDate()/7)*7;t=new Date(n.getFullYear(),n.getMonth(),r===0?4:r-3);break;case"months":var n=new Date(t.getFullYear(),t.getMonth(),1);n.setMonth(n.getMonth()-3);t=new Date(n.getFullYear(),n.getMonth(),1);break;default:t.setHours(0);t.setDate(t.getDate()-3)}return t},parseDateRange:function(e,t){var n=new Date(e.getTime()),r=new Date(t.getTime()),i=[],s=0;do{i[s++]=new Date(n.getTime());n.setDate(n.getDate()+1)}while(n.getTime()<=t.getTime());return i},parseTimeRange:function(e,t,n){var r=new Date(e),i=new Date(t),s=[],o=0;do{s[o]=new Date(r.getTime());r.setHours(r.getHours()+n);r.setHours(Math.floor(r.getHours()/n)*n);r.getDay()!==s[o].getDay()&&r.setHours(0);o++}while(r.getTime()<=t.getTime());return s},parseWeeksRange:function(e,t){var n=new Date(e),r=new Date(t),i=[],s=0;do{n.getDay()===0&&(i[s++]=n.getDayForWeek());n.setDate(n.getDate()+1)}while(n.getTime()<=t.getTime());return i},parseMonthsRange:function(e,t){var n=new Date(e),r=new Date(t),i=[],s=0;do{i[s++]=new Date(n.getFullYear(),n.getMonth(),1);n.setMonth(n.getMonth()+1)}while(n.getTime()<=t.getTime());return i},dateDeserialize:function(dateStr){var date=eval("new"+dateStr.replace(/\//g," "));return new Date(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes())},genId:function(e){var t=new Date(e);switch(settings.scale){case"hours":var n=t.getHours();arguments.length>=2&&(n=Math.floor(t.getHours()/arguments[1])*arguments[1]);return(new Date(t.getFullYear(),t.getMonth(),t.getDate(),n)).getTime();case"weeks":var r=t.getFullYear(),i=t.getDayForWeek().getWeekOfYear(),s=t.getMonth();s===11&&i===1&&r++;return r+"-"+i;case"months":return t.getFullYear()+"-"+t.getMonth();default:return(new Date(t.getFullYear(),t.getMonth(),t.getDate())).getTime()}},_getCellSize:null,getCellSize:function(){if(!tools._getCellSize){$("body").append($('<div style="display: none; position: absolute;" class="fn-gantt" id="measureCellWidth"><div class="row"></div></div>'));tools._getCellSize=$("#measureCellWidth .row").height();$("#measureCellWidth").empty().remove()}return tools._getCellSize},getRightPanelSize:function(){$("body").append($('<div style="display: none; position: absolute;" class="fn-gantt" id="measureCellWidth"><div class="rightPanel"></div></div>'));var e=$("#measureCellWidth .rightPanel").height();$("#measureCellWidth").empty().remove();return e},getPageHeight:function(e){return e.pageNum+1===e.pageCount?e.rowsOnLastPage*tools.getCellSize():settings.itemsPerPage*tools.getCellSize()},_getProgressBarMargin:null,getProgressBarMargin:function(){if(!tools._getProgressBarMargin){$("body").append($('<div style="display: none; position: absolute;" id="measureBarWidth" ><div class="fn-gantt"><div class="rightPanel"><div class="dataPanel"><div class="row day"><div class="bar" /></div></div></div></div></div>'));tools._getProgressBarMargin=parseInt($("#measureBarWidth .fn-gantt .rightPanel .day .bar").css("margin-left").replace("px",""),10);tools._getProgressBarMargin+=parseInt($("#measureBarWidth .fn-gantt .rightPanel .day .bar").css("margin-right").replace("px",""),10);$("#measureBarWidth").empty().remove()}return tools._getProgressBarMargin}};this.each(function(){options&&$.extend(settings,options);this.data=null;this.pageNum=0;this.pageCount=0;this.rowsOnLastPage=0;this.rowsNum=0;this.hPosition=0;this.dateStart=null;this.dateEnd=null;this.scrollClicked=!1;this.scaleOldWidth=null;this.headerRows=null;if(settings.useCookie){var e=$.cookie(this.cookieKey+"CurrentScale");e?settings.scale=$.cookie(this.cookieKey+"CurrentScale"):$.cookie(this.cookieKey+"CurrentScale",settings.scale)}switch(settings.scale){case"hours":this.headerRows=5;this.scaleStep=1;break;case"weeks":this.headerRows=3;this.scaleStep=13;break;case"months":this.headerRows=2;this.scaleStep=14;break;default:this.headerRows=4;this.scaleStep=13}this.scrollNavigation={panelMouseDown:!1,scrollerMouseDown:!1,mouseX:null,panelMargin:0,repositionDelay:0,panelMaxPos:0,canScroll:!0};this.gantt=null;this.loader=null;core.create(this)})}})(jQuery);